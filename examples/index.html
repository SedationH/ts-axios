<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>ts-axios examples</title>
    <link rel="stylesheet" href="/global.css" />
  </head>

  <body>
    <h1>ts-axios examples</h1>
    <ul>
      <li><a href="simple">Simple</a></li>
      <li><a href="base">Base</a></li>
      <li><a href="error">Error</a></li>
      <li><a href="extend">Extend</a></li>
      <li><a href="interceptor">Interceptor</a></li>
      <li><a href="config">Config</a></li>
      <li><a href="cancel">Caccel</a></li>
      <li><a href="more">More</a></li>
      <li><a href="upload-download">Upload</a></li>
    </ul>
  </body>
</html>

<script>
class CancelToken {
  constructor(executor) {
    let resolveFn
    this.promise = new Promise(resolve => {
      resolveFn = resolve
    })

    // 向executor中传入函数
    executor(message => {
      this.reason = message
      resolveFn(this.reason)
    })
  }
}

// 在使用axios的时候
function axios(config) {
  const { method, url, cancelToken } = config
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest()
    xhr.open(method.toUpperCase(), url, true)

    if (cancelToken) {
      cancelToken.promise.then(reason => {
        xhr.abort()
        reject(reason)
      })
    }

    xhr.send()

    xhr.addEventListener('loadend', () => {
      console.log('loadend', xhr.status)
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve(xhr)
      } else {
        reject(xhr)
      }
    })
  })
}

let cancel
axios({
  cancelToken: new CancelToken(c => (cancel = c)),
  url: '/simple/get',
  method: 'GET'
}).then(
  value => {
    console.log('value', value)
  },
  reason => {
    console.log('reason', reason)
  }
)
cancel('abort')
</script>
